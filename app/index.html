<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Optivolt</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            card: { DEFAULT: "#ffffff", dark: "#111827" },
            ink: { DEFAULT: "#0f172a", soft: "#475569" }
          },
          boxShadow: {
            soft: "0 1px 2px rgb(0 0 0 / 0.04), 0 8px 24px rgb(0 0 0 / 0.06)"
          },
          borderRadius: { pill: "9999px" }
        }
      },
      darkMode: "class"
    };
  </script>
  <style>
    :root {
      color-scheme: light;
    }
    :root.dark {
      color-scheme: dark;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <!-- Pattern fills for striped forecast bars -->
  <script src="https://cdn.jsdelivr.net/npm/patternomaly@1.3.2/dist/patternomaly.min.js"></script>
  <meta name="color-scheme" content="light dark">
</head>

<body class="min-h-full w-full bg-fixed bg-gradient-to-b from-slate-50 to-slate-100 text-ink dark:from-slate-900 dark:to-slate-950 dark:text-slate-100">
  <!-- Header -->
  <header class="border-b border-white/60 dark:border-white/5 bg-white/70 dark:bg-slate-900/60 backdrop-blur">
    <div class="mx-auto w-full max-w-7xl px-4 py-2 sm:py-3 flex items-center justify-between">
      <h1 class="text-2xl font-semibold tracking-tight">Optivolt DESS</h1>
      <div class="flex items-center gap-2">
        <!-- Appearance icon button -->
        <button id="themeToggle" class="rounded-full border border-slate-200 bg-white p-2 text-slate-700 shadow-sm hover:bg-slate-50 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700" title="Toggle theme" aria-label="Toggle theme">
          <!-- Sun/Moon SVG duo; we’ll toggle via CSS class -->
          <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v-3m0 21v-3M4.5 12h-3m21 0h-3M5.636 5.636l-2.121-2.122m16.97 16.972-2.122-2.122M5.636 18.364l-2.121 2.122m16.97-16.97-2.122 2.121M12 8a4 4 0 100 8 4 4 0 000-8z"/>
          </svg>
          <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
        </button>
        <a href="https://github.com/bmesuere/optivolt" target="_blank" rel="noopener"
           class="rounded-pill border border-slate-200 bg-white px-3 py-1.5 text-sm text-slate-700 shadow-sm hover:bg-slate-50 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
          GitHub
        </a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto w-full max-w-7xl px-4 py-8 grid gap-6 lg:grid-cols-3">
    <!-- Settings (now scrolls with the page) -->
    <aside class="lg:col-span-1 min-w-0">
      <div id="sidebar-stack"
           class="space-y-6 lg:pr-1">

        <!-- Settings (Algorithm) -->
        <section id="card-algo" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-base font-semibold">Settings</h2>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="text-sm">
              <span class="whitespace-nowrap">Terminal SoC valuation</span>
              <select id="terminal" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800">
                <option value="zero" selected>zero</option>
                <option value="min">min</option>
                <option value="avg">avg</option>
                <option value="max">max</option>
                <option value="custom">custom</option>
              </select>
            </label>
            <label class="text-sm">
              <span class="whitespace-nowrap">Custom terminal price</span>
              <div class="mt-1 relative">
                <input
                  id="terminal-custom"
                  type="number"
                  step="0.1"
                  min="0"
                  placeholder="e.g. 17.4"
                  class="w-full rounded-md border border-slate-200 bg-white p-2 pr-16 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                />
                <span class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-xs text-slate-500">
                  c€/kWh
                </span>
              </div>
            </label>
          </div>

          <!-- Run options -->
          <div class="mt-4 space-y-2 text-sm">
            <label class="flex items-center gap-2">
              <input id="update-data-before-run" type="checkbox" class="rounded border-slate-300 dark:border-white/10 dark:bg-slate-800">
              <span class="text-ink-soft">Update data before recompute</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="push-to-victron" type="checkbox" class="rounded border-slate-300 dark:border-white/10 dark:bg-slate-800">
              <span class="text-ink-soft">Push schedule to Victron</span>
            </label>
          </div>

          <!-- Recompute BELOW fields -->
          <div class="mt-4 flex justify-center">
            <button id="run"
              class="w-full sm:w-auto rounded-pill bg-sky-600 px-4 py-2 text-white shadow-soft hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-400/50">
              Recompute
            </button>
          </div>

          <!-- Plan summary -->
          <div class="mt-4 rounded-lg bg-slate-50 px-3 py-3 text-sm text-ink-soft dark:bg-slate-800/60">
            <div class="flex items-center justify-between gap-3">
              <div class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Status
              </div>
              <div id="status" class="text-sm font-medium text-ink dark:text-slate-100">
                Initializing…
              </div>
            </div>

            <dl class="mt-3 grid grid-cols-2 gap-x-4 gap-y-2">
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Current SoC
                </dt>
                <dd class="font-mono text-sm text-ink dark:text-slate-100">
                  <span id="plan-soc-now">—</span><span class="text-xs"> %</span>
                </dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Plan start
                </dt>
                <dd id="plan-ts-start" class="font-mono text-sm text-ink dark:text-slate-100">
                  —
                </dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Predicted load
                </dt>
                <dd id="sum-load-kwh" class="font-mono text-sm text-ink dark:text-slate-100">
                  —
                </dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Predicted PV
                </dt>
                <dd id="sum-pv-kwh" class="font-mono text-sm text-ink dark:text-slate-100">
                  —
                </dd>
              </div>
              <div class="col-span-2">
                <dt class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Load split (grid / battery / PV)
                </dt>
                <dd class="mt-1">
                  <div class="flex justify-between text-[11px] font-mono text-slate-600 dark:text-slate-300">
                    <span id="sum-load-grid-kwh" title="Grid">—</span>
                    <span id="sum-load-batt-kwh" title="Battery">—</span>
                    <span id="sum-load-pv-kwh" title="PV">—</span>
                  </div>
                  <!-- Mini stacked bar: grid / battery / PV -->
                  <div class="mt-2">
                    <div
                      class="flex h-2 w-full overflow-hidden rounded-full bg-slate-200/80 dark:bg-slate-700/80"
                      id="load-split-bar"
                    >
                      <div
                        id="load-split-grid-bar"
                        class="h-full flex-none"
                        style="width:0%; opacity:0;"
                      ></div>
                      <div
                        id="load-split-batt-bar"
                        class="h-full flex-none"
                        style="width:0%; opacity:0;"
                      ></div>
                      <div
                        id="load-split-pv-bar"
                        class="h-full flex-none"
                        style="width:0%; opacity:0;"
                      ></div>
                    </div>
                  </div>
                </dd>
              </div>
            </dl>

            <div class="mt-3 grid grid-cols-1 gap-y-1 border-t border-slate-200/70 pt-2 dark:border-white/10">
              <div class="flex items-baseline justify-between gap-3">
                <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Avg. import price
                </span>
                <span id="avg-import-cent" class="font-mono text-sm text-ink dark:text-slate-100">
                  —
                </span>
              </div>
              <div class="flex items-baseline justify-between gap-3">
                <span class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Grid/battery tipping point
                </span>
                <span id="tipping-point-cent" class="font-mono text-sm text-ink dark:text-slate-100">
                  —
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- System settings (Fixed) -->
        <section id="card-system" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div id="system-settings-header" class="mb-3 flex items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <button
                id="system-settings-toggle"
                type="button"
                class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-600 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-400/30 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 lg:hidden"
                aria-expanded="false"
                aria-controls="system-settings-body"
              >
                <svg id="system-settings-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5 transition-transform"><title>chevron</title><path fill="currentColor" d="m12 15l-5-5h10Z"/></svg>
              </button>
              <h2 class="text-base font-semibold">System settings</h2>
            </div>
            <button id="vrm-fetch-settings" type="button" title="Fetch settings from Victron VRM"
              class="inline-flex items-center gap-2 rounded-pill border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-400/30 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
              <!-- autorenew icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24"><title>autorenew</title><path fill="currentColor" d="M12 19C12 19.34 12.03 19.67 12.08 20H6.5C5 20 3.69 19.5 2.61 18.43C1.54 17.38 1 16.09 1 14.58C1 13.28 1.39 12.12 2.17 11.1S4 9.43 5.25 9.15C5.67 7.62 6.5 6.38 7.75 5.43S10.42 4 12 4C13.95 4 15.6 4.68 16.96 6.04C18.32 7.4 19 9.05 19 11C20.15 11.13 21.1 11.63 21.86 12.5C21.92 12.55 21.96 12.63 22 12.69C21.1 12.25 20.08 12 19 12C18.31 12 17.63 12.11 17 12.29V11C17 9.62 16.5 8.44 15.54 7.46C14.56 6.5 13.38 6 12 6S9.44 6.5 8.46 7.46C7.5 8.44 7 9.62 7 11H6.5C5.53 11 4.71 11.34 4.03 12.03C3.34 12.71 3 13.53 3 14.5S3.34 16.29 4.03 17C4.71 17.66 5.53 18 6.5 18H12.08C12.03 18.33 12 18.66 12 19M23.83 20.64L22.83 22.37C22.76 22.5 22.63 22.5 22.5 22.5L21.27 22C21 22.18 20.73 22.34 20.43 22.47L20.24 23.79C20.22 23.91 20.11 24 20 24H18C17.86 24 17.76 23.91 17.74 23.79L17.55 22.47C17.24 22.35 16.96 22.18 16.7 22L15.46 22.5C15.34 22.5 15.21 22.5 15.15 22.37L14.15 20.64C14.09 20.53 14.12 20.4 14.21 20.32L15.27 19.5C15.25 19.33 15.24 19.17 15.24 19S15.25 18.67 15.27 18.5L14.21 17.68C14.11 17.6 14.09 17.47 14.15 17.36L15.15 15.63C15.22 15.5 15.35 15.5 15.46 15.5L16.7 16C16.96 15.82 17.25 15.66 17.55 15.53L17.74 14.21C17.76 14.09 17.87 14 18 14H20C20.11 14 20.22 14.09 20.23 14.21L20.42 15.53C20.73 15.65 21 15.82 21.27 16L22.5 15.5C22.63 15.5 22.76 15.5 22.82 15.63L23.82 17.36C23.88 17.47 23.85 17.6 23.76 17.68L22.7 18.5C22.73 18.67 22.74 18.83 22.74 19S22.72 19.33 22.7 19.5L23.77 20.32C23.86 20.4 23.89 20.53 23.83 20.64M20.5 19C20.5 18.17 19.82 17.5 19 17.5S17.5 18.17 17.5 19 18.16 20.5 19 20.5 20.5 19.83 20.5 19Z" /></svg>
              <span class="hidden sm:inline">Fetch settings</span>
            </button>
          </div>

          <div id="system-settings-body" class="grid grid-cols-1 gap-3 md:grid-cols-2 hidden lg:grid">
            <!-- Row 1: Capacity + Battery cost -->
            <label class="text-sm">Battery capacity (Wh)
              <input id="cap" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">
              <span class="whitespace-nowrap">Battery cost (c€/kWh)</span>
              <input id="bwear" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 2: Min/Max SoC -->
            <label class="text-sm">Min SoC (%)
              <input id="minsoc" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Max SoC (%)
              <input id="maxsoc" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 3: Battery power limits -->
            <label class="text-sm">Max charge (W)
              <input id="pchg" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Max discharge (W)
              <input id="pdis" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 4: Grid import/export -->
            <label class="text-sm">Max grid import (W)
              <input id="gimp" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Max grid export (W)
              <input id="gexp" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 5: Efficiencies -->
            <label class="text-sm">Charge efficiency (%)
              <input id="etaC" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Discharge efficiency (%)
              <input id="etaD" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <label class="text-sm">Step (min)
              <input id="step" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
          </div>
        </section>
      </div>
    </aside>

    <!-- Results (charts) -->
    <section class="lg:col-span-2 space-y-6 min-w-0">
      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Power flows</h3>
        <div class="h-72 w-full">
          <canvas id="flows" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Battery SoC</h3>
        <div class="h-40 w-full">
          <canvas id="soc" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Energy prices</h3>
        <div class="h-56 w-full">
          <canvas id="prices" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Predicted load and solar</h3>
        <div class="h-56 w-full">
          <canvas id="loadpv" class="h-full w-full"></canvas>
        </div>
      </div>
    </section>

    <!-- Full-width table -->
    <section class="lg:col-span-3 min-w-0">
      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark overflow-auto">
        <h3 class="mb-3 text-base font-semibold">Schedule table</h3>
        <div class="mb-2 flex items-center justify-between gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="table-kwh" type="checkbox" class="rounded border-slate-300">
            <span>Show kWh in table</span>
          </label>
          <!-- dynamic unit badge -->
          <span id="table-unit"
            class="inline-flex items-center rounded-full border border-slate-200 px-2 py-0.5 text-xs text-slate-700 dark:border-white/10 dark:text-slate-200">
            Units: W
          </span>
        </div>
        <table id="table" class="min-w-full text-sm"></table>
      </div>
    </section>
  </main>


  <footer class="mx-auto w-full max-w-7xl px-4 py-8 text-center text-xs text-ink-soft">
    Built with HiGHS (WASM) + Chart.js + Tailwind. Changes run instantly.
  </footer>

  <!-- App -->
  <script type="module" src="./main.js"></script>
  <script>
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const STORAGE_KEY = 'optivolt-theme'; // 'light' | 'dark' | null (system)
    const mq = window.matchMedia('(prefers-color-scheme: dark)');

    function getStoredTheme() {
      const v = localStorage.getItem(STORAGE_KEY);
      if (v === 'light' || v === 'dark') return v;
      return null; // system
    }

    function getEffectiveTheme() {
      const stored = getStoredTheme();
      if (stored) return stored;
      return mq.matches ? 'dark' : 'light'; // system preference
    }

    function applyTheme() {
      const theme = getEffectiveTheme();
      root.classList.toggle('dark', theme === 'dark');
      // color-scheme is handled by CSS: :root / :root.dark above
    }

    // Initial
    applyTheme();

    // If we're in "system" mode, react to OS changes
    if (mq.addEventListener) {
      mq.addEventListener('change', () => {
        if (!getStoredTheme()) applyTheme();
      });
    } else if (mq.addListener) {
      mq.addListener(() => {
        if (!getStoredTheme()) applyTheme();
      });
    }

    // Button cycles:
    // system → opposite-of-system → other override → back to system
    btn?.addEventListener('click', () => {
      const stored = getStoredTheme();
      let next = null;

      if (!stored) {
        // From system: go to explicit opposite so the toggle "does something"
        next = mq.matches ? 'light' : 'dark';
      } else if (stored === 'dark') {
        next = 'light';
      } else if (stored === 'light') {
        next = null; // back to system
      }

      if (next) {
        localStorage.setItem(STORAGE_KEY, next);
      } else {
        localStorage.removeItem(STORAGE_KEY);
      }

      applyTheme();
    });
  </script>

</body>
</html>
