<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VRM API POC – Client-side tester</title>
<style>
  :root { --gap: 12px; --pad: 10px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin: 0; padding: 0; background: #0b0d10; color: #e7ebf0; }
  header { padding: 16px 20px; background: #0f141a; border-bottom: 1px solid #223041; }
  h1 { margin: 0; font-size: 18px; font-weight: 650; }
  main { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); padding: 16px; }
  section { background: #0f141a; border: 1px solid #223041; border-radius: 10px; padding: 14px; }
  section h2 { margin: 0 0 8px 0; font-size: 15px; font-weight: 650; color: #c7d2de; }
  label { font-size: 12px; color: #9fb1c5; display: block; margin: 8px 0 4px; }
  input, select, textarea { width: 100%; background: #0b0f15; color: #e7ebf0; border: 1px solid #2a3a4f; border-radius: 8px; padding: 8px; font-size: 13px; }
  textarea { font-family: var(--mono); resize: vertical; min-height: 80px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
  .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
  .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  button { background: #1e2a3a; color: #e7ebf0; border: 1px solid #2a3a4f; border-radius: 8px; padding: 8px 12px; font-size: 13px; cursor: pointer; }
  button.primary { background: #245da6; border-color: #2b6fca; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .small { font-size: 12px; color: #95a7ba; }
  .muted { color: #9fb1c5; }
  .mono { font-family: var(--mono); }
  .kv { display: grid; grid-template-columns: max-content 1fr; gap: 4px 10px; align-items: start; }
  pre { background: #0b0f15; border: 1px solid #2a3a4f; border-radius: 8px; padding: 10px; overflow: auto; }
  .ok { color: #6df0a3; }
  .bad { color: #ff8383; }
  .warn { color: #ffd479; }
  .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .tag { padding:2px 6px; border-radius:6px; background:#132130; border:1px solid #20344a; font-size:12px; }
  .grid { display: grid; gap: var(--gap); }
  .bigpath { font-family: var(--mono); font-size: 16px; padding: 12px; }
  @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<header>
  <h1>VRM API POC (client-side)</h1>
</header>

<main>
  <section>
    <h2>Credentials & Base</h2>
    <div class="grid">
      <div class="row">
        <div>
          <label>Base URL</label>
          <input id="base" value="https://vrmapi.victronenergy.com/v2" />
          <div class="small">You can change this if you experiment with a different gateway.</div>
        </div>
        <div>
          <label>Installation ID</label>
          <input id="installationId" placeholder="e.g. 123456" />
        </div>
      </div>
      <div>
        <label>VRM API token</label>
        <input id="token" type="password" placeholder="Paste VRM token" autocomplete="off" />
        <div class="btns">
          <button id="save" class="primary">Save</button>
          <button id="clear">Clear</button>
          <span class="small">Stored locally in your browser (<code>localStorage</code>).</span>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Request</h2>
    <div class="grid">
      <div class="row3">
        <div>
          <label>Method</label>
          <select id="method">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
            <option>OPTIONS</option>
          </select>
        </div>
        <div>
          <label>Path (relative to Base)</label>
          <input id="path" class="bigpath" placeholder="/users/me or /systems/{id}/..." />
        </div>
        <div>
          <label>Include Authorization header</label>
          <select id="includeAuth">
            <option value="yes" selected>yes</option>
            <option value="no">no</option>
          </select>
          <div class="small">Sends <span class="mono">X-Authorization: Token &lt;token&gt;</span></div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Query params (JSON object)</label>
          <textarea id="query">{}</textarea>
        </div>
        <div>
          <label>Body (for POST/PUT, JSON)</label>
          <textarea id="body"></textarea>
        </div>
      </div>
      <div class="btns">
        <button id="send" class="primary">Send request</button>
        <button id="prefill-users">Try: <span class="mono">/users/me</span></button>
        <button id="prefill-systems">Try: <span class="mono">/systems</span></button>
        <button id="prefill-system-guess">Try (needs ID): <span class="mono">/systems/{id}/overview</span></button>
        <button id="prefill-forecast-pv">Try (guess): <span class="mono">/systems/{id}/forecast/solar</span></button>
        <button id="prefill-forecast-load">Try (guess): <span class="mono">/systems/{id}/forecast/load</span></button>
      </div>
    </div>
  </section>

  <section>
    <h2>Response</h2>
    <div class="grid">
      <div class="kv mono">
        <div>Request URL</div><div id="reqUrl" class="muted">—</div>
        <div>Status</div><div id="status" class="muted">—</div>
        <div>OK</div><div id="ok" class="muted">—</div>
        <div>Type</div><div id="restype" class="muted">—</div>
      </div>
      <div>
        <label>Response headers</label>
        <pre id="headers">—</pre>
      </div>
      <div>
        <label>Body (parsed or raw)</label>
        <pre id="bodyOut">—</pre>
      </div>
      <div>
        <label>Diagnostics</label>
        <pre id="diag">—</pre>
      </div>
    </div>
  </section>

  <section>
    <h2>Quick Normalizers (optional)</h2>
    <div class="small">Paste a response and check the shape you want for your planner.</div>
    <div class="row">
      <div>
        <label class="flex">PV Forecast JSON <span class="tag">input</span></label>
        <textarea id="pvIn" placeholder='{"points":[{"time":"...","value":123}]}'></textarea>
        <div class="btns">
          <button id="pvNorm">Normalize</button>
        </div>
      </div>
      <div>
        <label class="flex">Normalized PV (W @ 15m) <span class="tag">output</span></label>
        <pre id="pvOut">—</pre>
      </div>
    </div>
    <div class="row">
      <div>
        <label class="flex">Load Forecast JSON <span class="tag">input</span></label>
        <textarea id="loadIn" placeholder='{"points":[{"time":"...","value":123}]}'></textarea>
        <div class="btns">
          <button id="loadNorm">Normalize</button>
        </div>
      </div>
      <div>
        <label class="flex">Normalized Load (W @ 15m) <span class="tag">output</span></label>
        <pre id="loadOut">—</pre>
      </div>
    </div>
    <div class="row">
      <div>
        <label class="flex">Prices JSON <span class="tag">input</span></label>
        <textarea id="priceIn" placeholder='{"points":[{"time":"...","value":7.12}]}'></textarea>
        <div class="btns">
          <button id="priceNorm">Normalize</button>
        </div>
      </div>
      <div>
        <label class="flex">Normalized Prices (c€/kWh @ 60m) <span class="tag">output</span></label>
        <pre id="priceOut">—</pre>
      </div>
    </div>
  </section>
</main>

<script>
  const $ = (s) => document.querySelector(s);
  const cfg = {
    get base() { return $('#base').value.trim(); },
    get id() { return $('#installationId').value.trim(); },
    get token() { return $('#token').dataset.real || ''; }, // keep masked display separate
  };

  // Load from localStorage
  (function hydrate() {
    const installationId = localStorage.getItem('vrm.installationId') || '';
    const token = localStorage.getItem('vrm.token') || '';
    $('#installationId').value = installationId;
    if (token) {
      $('#token').value = '••••••••••';
      $('#token').dataset.real = token;
    }
  })();

  $('#save').addEventListener('click', () => {
    const idVal = $('#installationId').value.trim();
    const currentMasked = $('#token').value;
    const existing = $('#token').dataset.real || '';
    const tokenVal = (currentMasked && !currentMasked.startsWith('••••')) ? currentMasked.trim() : existing;
    localStorage.setItem('vrm.installationId', idVal);
    localStorage.setItem('vrm.token', tokenVal);
    $('#token').dataset.real = tokenVal;
    if (tokenVal && currentMasked && !currentMasked.startsWith('••••')) $('#token').value = '••••••••••';
    alert('Saved.');
  });

  $('#clear').addEventListener('click', () => {
    localStorage.removeItem('vrm.installationId');
    localStorage.removeItem('vrm.token');
    $('#installationId').value = '';
    $('#token').value = '';
    delete $('#token').dataset.real;
    alert('Cleared.');
  });

  // Prefills (paths are guesses—edit as needed)
  $('#prefill-users').addEventListener('click', () => {
    $('#method').value = 'GET';
    $('#path').value = '/users/me';
    $('#query').value = '{}';
    $('#body').value = '';
  });

  $('#prefill-systems').addEventListener('click', () => {
    $('#method').value = 'GET';
    $('#path').value = '/systems'; // adjust if VRM uses a different listing path
    $('#query').value = JSON.stringify({ page: 1, per_page: 10 }, null, 2);
    $('#body').value = '';
  });

  $('#prefill-system-guess').addEventListener('click', () => {
    const id = cfg.id || '{installationId}';
    $('#method').value = 'GET';
    $('#path').value = `/systems/${id}/overview`;
    $('#query').value = '{}';
    $('#body').value = '';
  });

  $('#prefill-forecast-pv').addEventListener('click', () => {
    const id = cfg.id || '{installationId}';
    $('#method').value = 'GET';
    $('#path').value = `/systems/${id}/forecast/solar`;
    $('#query').value = JSON.stringify({ horizon_hours: 48 }, null, 2);
    $('#body').value = '';
  });

  $('#prefill-forecast-load').addEventListener('click', () => {
    const id = cfg.id || '{installationId}';
    $('#method').value = 'GET';
    $('#path').value = `/systems/${id}/forecast/load`;
    $('#query').value = JSON.stringify({ horizon_hours: 48 }, null, 2);
    $('#body').value = '';
  });

  function pretty(obj) {
    try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
  }

  function setResp({ url, status, ok, type, headers, body, diag }) {
    $('#reqUrl').textContent = url || '—';
    $('#status').innerHTML = status == null ? '—' :
      (ok ? `<span class="ok">${status}</span>` :
            (status ? `<span class="bad">${status}</span>` : `<span class="warn">—</span>`));
    $('#ok').textContent = ok == null ? '—' : String(ok);
    $('#restype').textContent = type || '—';
    $('#headers').textContent = headers || '—';
    $('#bodyOut').textContent = body || '—';
    $('#diag').textContent = diag || '—';
  }

  async function send() {
    setResp({ url: '—', status: '—', ok: '—', type: '—', headers: '—', body: '—', diag: '—' });
    $('#send').disabled = true;

    let method = $('#method').value;
    let base = $('#base').value.trim().replace(/\/+$/, '');
    let path = $('#path').value.trim();
    let includeAuth = $('#includeAuth').value === 'yes';

    if (!path.startsWith('/')) path = '/' + path;

    let query = {};
    let body = undefined;

    try {
      const qText = $('#query').value.trim() || '{}';
      query = JSON.parse(qText);
    } catch (e) {
      setResp({ diag: 'Query JSON parse error: ' + e.message });
      $('#send').disabled = false;
      return;
    }

    try {
      const bText = $('#body').value.trim();
      if (bText) body = JSON.stringify(JSON.parse(bText));
    } catch (e) {
      setResp({ diag: 'Body JSON parse error: ' + e.message });
      $('#send').disabled = false;
      return;
    }

    const u = new URL(base + path);
    Object.entries(query).forEach(([k, v]) => {
      if (v != null) u.searchParams.set(k, String(v));
    });

    const headers = { 'Accept': 'application/json' };
    if (includeAuth) {
      if (!cfg.token) {
        setResp({ url: u.toString(), diag: 'Missing token but auth header is enabled.' });
        $('#send').disabled = false;
        return;
      }
      // Use "Token" per your request
      headers['X-Authorization'] = `Token ${cfg.token}`;
    }
    if (body && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
      headers['Content-Type'] = 'application/json';
    }

    let res = null;
    try {
      res = await fetch(u.toString(), { method, headers, body: body || undefined });
    } catch (err) {
      setResp({
        url: u.toString(),
        status: null,
        ok: null,
        type: 'network-error',
        headers: '',
        body: '',
        diag: 'Network/Fetch error. Check console for details.'
      });
      $('#send').disabled = false;
      return;
    }

    const headerObj = {};
    res.headers.forEach((v, k) => { headerObj[k] = v; });

    let bodyText = '';
    try {
      const clone = res.clone();
      const parsed = await clone.json();
      bodyText = JSON.stringify(parsed, null, 2);
    } catch {
      try {
        bodyText = await res.text();
      } catch {
        bodyText = '[unreadable body]';
      }
    }

    setResp({
      url: u.toString(),
      status: res.status,
      ok: res.ok,
      type: res.type,
      headers: pretty(headerObj),
      body: bodyText,
      diag: ''
    });

    $('#send').disabled = false;
  }

  $('#send').addEventListener('click', send);

  // Normalizers (simple demo passthroughs)
  function normTimeSeries(input, { unit='W', step_minutes=15 } = {}) {
    const out = { unit, step_minutes, points: [] };
    try {
      const obj = (typeof input === 'string') ? JSON.parse(input) : input;
      if (obj && Array.isArray(obj.points)) {
        out.points = obj.points.map(p => ({ time: p.time, value: Number(p.value) }));
      }
    } catch(e) {
      out.points = [];
    }
    return out;
  }

  $('#pvNorm').addEventListener('click', () => {
    const v = $('#pvIn').value.trim();
    $('#pvOut').textContent = JSON.stringify(normTimeSeries(v, { unit:'W', step_minutes: 15 }), null, 2);
  });
  $('#loadNorm').addEventListener('click', () => {
    const v = $('#loadIn').value.trim();
    $('#loadOut').textContent = JSON.stringify(normTimeSeries(v, { unit:'W', step_minutes: 15 }), null, 2);
  });
  $('#priceNorm').addEventListener('click', () => {
    const v = $('#priceIn').value.trim();
    $('#priceOut').textContent = JSON.stringify(normTimeSeries(v, { unit:'c€/kWh', step_minutes: 60 }), null, 2);
  });

  // Capture real token on edit (avoid replacing with bullets)
  $('#token').addEventListener('input', (e) => {
    const v = e.target.value;
    if (!v.startsWith('••••')) {
      $('#token').dataset.real = v.trim();
    }
  });
</script>
</body>
</html>
