<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battery Optimizer</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            card: { DEFAULT: "#ffffff", dark: "#111827" },
            ink: { DEFAULT: "#0f172a", soft: "#475569" }
          },
          boxShadow: {
            soft: "0 1px 2px rgb(0 0 0 / 0.04), 0 8px 24px rgb(0 0 0 / 0.06)"
          },
          borderRadius: { pill: "9999px" }
        }
      },
      darkMode: "class"
    };
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <!-- Pattern fills for striped forecast bars -->
  <script src="https://cdn.jsdelivr.net/npm/patternomaly@1.3.2/dist/patternomaly.min.js"></script>
  <!-- HiGHS UMD (defines global `Module`) -->
  <script src="https://lovasoa.github.io/highs-js/highs.js"></script>

  <meta name="color-scheme" content="light dark">
</head>

<body class="min-h-full overflow-x-hidden bg-fixed bg-gradient-to-b from-slate-50 to-slate-100 text-ink dark:from-slate-900 dark:to-slate-950 dark:text-slate-100">
  <!-- Header -->
  <header class="border-b border-white/60 dark:border-white/5 bg-white/70 dark:bg-slate-900/60 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-5 flex items-center justify-between">
      <h1 class="text-2xl font-semibold tracking-tight">Battery Optimizer</h1>
      <div class="flex items-center gap-2">
        <!-- Appearance icon button -->
        <button id="themeToggle" class="rounded-full border border-slate-200 bg-white p-2 text-slate-700 shadow-sm hover:bg-slate-50 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700" title="Toggle theme" aria-label="Toggle theme">
          <!-- Sun/Moon SVG duo; we’ll toggle via CSS class -->
          <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5v-3m0 21v-3M4.5 12h-3m21 0h-3M5.636 5.636l-2.121-2.122m16.97 16.972-2.122-2.122M5.636 18.364l-2.121 2.122m16.97-16.97-2.122 2.121M12 8a4 4 0 100 8 4 4 0 000-8z"/>
          </svg>
          <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
        </button>
        <a href="https://github.com/bmesuere/optivolt" target="_blank" rel="noopener"
           class="rounded-pill border border-slate-200 bg-white px-3 py-1.5 text-sm text-slate-700 shadow-sm hover:bg-slate-50 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
          GitHub
        </a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-4 py-8 grid gap-6 lg:grid-cols-3">
    <!-- Settings (independent scroll on large) -->
    <aside class="lg:col-span-1">
      <div id="sidebar-stack"
          class="space-y-6 lg:sticky lg:top-4 lg:max-h-[calc(100vh-2rem)] lg:overflow-y-auto lg:pr-1">

        <!-- Settings (Algorithm) -->
        <section id="card-algo" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-base font-semibold">Settings</h2>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="text-sm">
              <span class="whitespace-nowrap">Terminal SoC valuation</span>
              <select id="terminal" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800">
                <option value="zero" selected>zero</option>
                <option value="min">min</option>
                <option value="avg">avg</option>
                <option value="max">max</option>
              </select>
            </label>
          </div>

          <!-- Recompute BELOW fields -->
          <div class="mt-4">
            <button id="run"
              class="rounded-pill bg-sky-600 px-4 py-2 text-white shadow-soft hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-400/50">
              Recompute
            </button>
          </div>

          <div class="mt-4 rounded-lg bg-slate-50 px-3 py-2 text-sm text-ink-soft dark:bg-slate-800/60">
            <div>Total cost: <span id="objective" class="font-medium text-ink">—</span> c€</div>
            <div class="mt-0.5">Status: <span id="status" class="font-medium text-ink">Initializing…</span></div>
          </div>
        </section>

        <!-- Data -->
        <section id="card-data" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-base font-semibold">Data</h2>
            <button id="vrm-fetch-forecasts" type="button"
              class="inline-flex items-center gap-2 rounded-pill border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-400/30 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
              <!-- autorenew icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24"><title>autorenew</title><path d="M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12C4,13.57 4.46,15.03 5.24,16.26L6.7,14.8C6.25,13.97 6,13 6,12A6,6 0 0,1 12,6M18.76,7.74L17.3,9.2C17.74,10.04 18,11 18,12A6,6 0 0,1 12,18V15L8,19L12,23V20A8,8 0 0,0 20,12C20,10.43 19.54,8.97 18.76,7.74Z"/></svg>
              <span>Update</span>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="text-sm">Current SoC (%)
              <input id="initsoc" type="number" value="20"
                class="mt-1 w-full rounded-md border border-green-400 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-green-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <label class="text-sm">Step (min)
              <input id="step" type="number" value="60"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <label class="text-sm md:col-span-2">Start time
              <input id="ts-start" type="datetime-local"
                class="mt-1 w-full rounded border p-2 text-sm" />
              <p class="mt-1 text-[11px] text-slate-500">
                First slot timestamp. Filled automatically when loading from VRM.
              </p>
            </label>

            <div class="md:col-span-2 space-y-3">
              <p class="text-xs font-medium text-ink-soft">Time series (comma or whitespace separated)</p>
              <label class="block text-sm">Load (W)
                <textarea id="ts-load" rows="2" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm font-mono shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800"></textarea>
              </label>
              <label class="block text-sm">PV (W)
                <textarea id="ts-pv" rows="2" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm font-mono shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800"></textarea>
              </label>
              <label class="block text-sm">Import price (c€/kWh)
                <textarea id="ts-ic" rows="2" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm font-mono shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800"></textarea>
              </label>
              <label class="block text-sm">Export price (c€/kWh)
                <textarea id="ts-ec" rows="2" class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm font-mono shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800"></textarea>
              </label>
            </div>
          </div>
        </section>

        <!-- System settings (Fixed) -->
        <section id="card-system" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-base font-semibold">System settings</h2>
            <button id="vrm-fetch-settings" type="button"
              class="inline-flex items-center gap-2 rounded-pill border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-400/30 dark:border-white/10 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
              <!-- autorenew icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24"><title>autorenew</title><path d="M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12C4,13.57 4.46,15.03 5.24,16.26L6.7,14.8C6.25,13.97 6,13 6,12A6,6 0 0,1 12,6M18.76,7.74L17.3,9.2C17.74,10.04 18,11 18,12A6,6 0 0,1 12,18V15L8,19L12,23V20A8,8 0 0,0 20,12C20,10.43 19.54,8.97 18.76,7.74Z"/></svg>
              <span class="hidden sm:inline">Fetch settings</span>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Row 1: Capacity + Battery cost -->
            <label class="text-sm">Battery capacity (Wh)
              <input id="cap" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">
              <span class="whitespace-nowrap">Battery cost (c€/kWh)</span>
              <input id="bwear" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 2: Min/Max SoC -->
            <label class="text-sm">Min SoC (%)
              <input id="minsoc" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Max SoC (%)
              <input id="maxsoc" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 3: Charge/Discharge -->
            <label class="text-sm">Maximum charge speed (W)
              <input id="pchg" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Maximum discharge speed (W)
              <input id="pdis" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 4: Grid import/export -->
            <label class="text-sm">Max grid import (W)
              <input id="gimp" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Max grid export (W)
              <input id="gexp" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>

            <!-- Row 5: Efficiencies -->
            <label class="text-sm">Charge efficiency (%)
              <input id="etaC" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">Discharge efficiency (%)
              <input id="etaD" type="number"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
          </div>
        </section>

        <!-- Victron VRM -->
        <section id="card-vrm" class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
          <div class="mb-2 flex items-center justify-between">
            <h2 class="text-base font-semibold">Victron VRM</h2>
            <span id="badge-vrm" class="text-xs text-ink-soft"></span>
          </div>
          <p class="text-xs text-ink-soft mb-4">
            Enter your VRM site id and API token. The token is <b>stored only in this browser</b> and used directly by this page.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="text-sm">Site id
              <input id="vrm-site" type="text" inputmode="numeric" autocomplete="off"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm">API token
              <input id="vrm-token" type="password" autocomplete="off"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
            </label>
            <label class="text-sm md:col-span-2">Proxy base URL
              <input id="vrm-proxy" type="url" placeholder="https://your-proxy.example.com"
                class="mt-1 w-full rounded-md border border-slate-200 bg-white p-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40 dark:border-white/10 dark:bg-slate-800" />
              <p class="mt-1 text-[11px] text-slate-500">
                Browsers block direct calls to the VRM API due to CORS. Use a small proxy that forwards requests and adds CORS headers.
  See <a href="https://github.com/bmesuere/optivolt/README.md#using-a-cloudflare-worker-as-a-cors-proxy" target="_blank" rel="noopener" class="underline">how to set up a Cloudflare Worker proxy</a> or use the default.
              </p>
            </label>
            <div class="md:col-span-2">
              <button id="vrm-clear" type="button"
                class="inline-flex items-center gap-1.5 text-sm text-sky-700 underline-offset-4 hover:underline dark:text-sky-300">
                <span aria-hidden="true">🧹</span>
                <span>Clear credentials</span>
              </button>
            </div>
          </div>
        </section>
      </div>
    </aside>




    <!-- Results (stacked vertically, no side-by-side charts) -->
    <section class="lg:col-span-2 space-y-6 min-w-0">
      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Power flows (kWh)</h3>
        <div class="h-72 w-full">
          <canvas id="flows" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">State of charge</h3>
        <div class="h-40 w-full">
          <canvas id="soc" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Prices (Buy/Sell)</h3>
        <div class="h-56 w-full">
          <canvas id="prices" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark">
        <h3 class="mb-3 text-base font-semibold">Predicted load and solar</h3>
        <div class="h-56 w-full">
          <canvas id="loadpv" class="h-full w-full"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-card p-5 shadow-soft dark:border-white/10 dark:bg-card-dark overflow-auto">
        <h3 class="mb-3 text-base font-semibold">Schedule table</h3>
        <div class="mb-2 flex items-center justify-between gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="table-kwh" type="checkbox" class="rounded border-slate-300">
            <span>Show kWh in table</span>
          </label>
          <!-- dynamic unit badge -->
          <span id="table-unit"
            class="inline-flex items-center rounded-full border border-slate-200 px-2 py-0.5 text-xs text-slate-700 dark:border-white/10 dark:text-slate-200">
            Units: W
          </span>
        </div>
        <table id="table" class="min-w-full text-sm"></table>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-7xl px-4 py-8 text-center text-xs text-ink-soft">
    Built with HiGHS (WASM) + Chart.js + Tailwind. Changes run instantly.
  </footer>

  <!-- App -->
  <script type="module" src="./app.js"></script>
  <script>
    // Appearance toggle (persists)
    const btn = document.getElementById('themeToggle');
    const root = document.documentElement;
    const key = 'battery-ui-theme';
    const saved = localStorage.getItem(key);
    if (saved === 'dark') root.classList.add('dark');
    btn?.addEventListener('click', () => {
      root.classList.toggle('dark');
      localStorage.setItem(key, root.classList.contains('dark') ? 'dark' : 'light');
    });
  </script>
</body>
</html>
